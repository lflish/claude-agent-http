# ============================================
# Claude Agent HTTP - Unified Docker Compose
# ============================================
# This unified compose file supports multiple deployment modes through environment variables.
#
# Usage Examples:
#   1. SQLite + Named Volumes (Default - Production Recommended):
#      docker-compose up -d
#
#   2. SQLite + Bind Mounts (Development):
#      cp docker-compose.override.bindmounts.yml docker-compose.override.yml
#      docker-compose up -d
#
#   3. PostgreSQL (Enterprise):
#      docker-compose -f docker-compose.yml -f docker-compose.postgres.yml up -d
#
#   4. Use helper script (validates configuration):
#      ./docker-start.sh                # SQLite mode
#      ./docker-start.sh --postgres     # PostgreSQL mode
#
# Configuration:
#   - Edit .env file to set your configuration
#   - Default storage: SQLite (recommended for most use cases)
#   - For PostgreSQL: use docker-compose.postgres.yml
#
# ============================================

version: '3.8'

services:
  # ============================================
  # Claude Agent HTTP API Service
  # ============================================
  app:
    # 使用公共镜像（推荐）
    # image: ccr.ccs.tencentyun.com/claude/claude-agent-http:v1.0.0-20260119

    # 或者本地构建（需要先执行 ./build.sh）
    build:
      context: .
      dockerfile: Dockerfile
    image: ${DOCKER_IMAGE_NAME:-ccr.ccs.tencentyun.com/claude/claude-agent-http}:${IMAGE_TAG:-v1.0.0-20260119}
    container_name: claude-agent-http
    restart: unless-stopped

    # Note: Container starts as root, then switches to claudeuser in entrypoint
    # This allows entrypoint to fix volume permissions before switching users
    # For bind mounts, set UID/GID in .env to match your host user

    environment:
      # ============================================
      # Core Configuration
      # ============================================
      HOME: /home/claudeuser

      # User working directory
      CLAUDE_AGENT_USER_BASE_DIR: ${CLAUDE_AGENT_USER_BASE_DIR:-/data/claude-users}

      # Session storage: memory | sqlite | postgresql
      CLAUDE_AGENT_SESSION_STORAGE: ${CLAUDE_AGENT_SESSION_STORAGE:-sqlite}
      CLAUDE_AGENT_SESSION_SQLITE_PATH: ${CLAUDE_AGENT_SESSION_SQLITE_PATH:-/home/claudeuser/.claude/sessions.db}

      # ============================================
      # Anthropic API Configuration (Optional)
      # ============================================
      # Set in .env file based on your authentication method:
      # Standard: ANTHROPIC_API_KEY
      # Custom endpoint: ANTHROPIC_BASE_URL + ANTHROPIC_AUTH_TOKEN
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_BASE_URL: ${ANTHROPIC_BASE_URL:-}
      ANTHROPIC_AUTH_TOKEN: ${ANTHROPIC_AUTH_TOKEN:-}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-}

    volumes:
      # Named volumes (default): Docker manages permissions automatically
      # For bind mounts: copy docker-compose.override.bindmounts.yml to docker-compose.override.yml
      - ~/.claude-data:/home/claudeuser/.claude    # Claude SDK data (session history, cache)
      - ~/claude-users:/data/claude-users          # User working directories
      # Optional: Custom config file
      - ${HOST_CONFIG_FILE:-./config.yaml}:/app/config.yaml:ro

    ports:
      - "${API_PORT:-8000}:8000"

    networks:
      - claude-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ============================================
# Named Volumes
# ============================================
# Docker automatically manages permissions for named volumes
volumes:
  claude-data:
    driver: local
  claude-users:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  claude-network:
    driver: bridge
